var Elevator=function(n){"use strict";function e(n,e,o,t){return n/=t/2,1>n?o/2*n*n+e:(n--,-o/2*(n*(n-2)-1)+e)}function o(n,e){for(var o in e){var t=void 0===n[o]&&"function"!=typeof o;t&&(n[o]=e[o])}return n}function t(n){for(var e=0;n;)e+=n.offsetTop||0,n=n.offsetParent;return e}function i(n){w||(w=n);var o=n-w,t=e(o,E,T-E,p);window.scrollTo(0,t),p>o?A=requestAnimationFrame(i):l()}function u(){return window.requestAnimationFrame&&window.Audio&&window.addEventListener}function r(){w=null,E=null,b=!1}function l(){r(),m&&(m.pause(),m.currentTime=0),s&&s.play()}function d(){b&&(cancelAnimationFrame(A),r(),m&&(m.pause(),m.currentTime=0),window.scrollTo(0,T))}function a(n){n.addEventListener?n.addEventListener("click",y.elevate,!1):n.attachEvent("onclick",function(){document.documentElement.scrollTop=T,document.body.scrollTop=T,window.scroll(0,T)})}function c(n){f=document.body;var e={duration:void 0,mainAudio:!1,endAudio:!1,preloadAudio:!0,loopAudio:!0};n=o(n,e),n.element&&a(n.element),u()&&(n.duration&&(v=!0,p=n.duration),n.targetElement&&(T=t(n.targetElement)),window.addEventListener("blur",d,!1),n.mainAudio&&(m=new Audio(n.mainAudio),m.setAttribute("preload",n.preloadAudio),m.setAttribute("loop",n.loopAudio)),n.endAudio&&(s=new Audio(n.endAudio),s.setAttribute("preload","true")))}var m,s,f=null,A=null,p=null,v=!1,w=null,E=null,T=0,b=!1,y=this;this.elevate=function(){b||(b=!0,E=document.documentElement.scrollTop||f.scrollTop,v||(p=1.5*E),requestAnimationFrame(i),m&&m.play())},c(n)};
// Really crappy js, made even crapper by ad-hoc optimizations :)

(function() {
  var pages = [
    'idea',
    'team',
    'product',
    'execution',
    'growth',
    'focus',
    'ceo',
    'hiring',
    'competition',
    'money',
    'fundraising',
    'closing',
  ];

  // Mobile setup
  var isMobileSetup = false;
  if($(window).width() <= 760) {
    setupMobile();
  }

  $(window).resize(function() {
    if(!isMobileSetup && $(window).width() <= 760) {
      setupMobile();
    }
  });

  function setupMobile() {
    isMobileSetup = true;
    $('.mobile-wrapper').each(function() {
      var $clone = $('h3', this).clone().addClass('is-mobile');
      $(this).after($clone);
      var name = $(this).prev().attr('id');
      $clone.before($('<img>', {
        src: '/img/'+name+'/circle@2x.png',
        class: 'mobile-circle',
      }));
    });
  }

  // Scroll stuff
  var $cached = {};
  var cachedValues = {};

  $.each(pages, function(k, i) {
    $cached[i] = $('.bg-' + i);
    cachedValues[i] = false;
  });
  $w = $(window);

  $closing_sky = $('.bg-closing .sky');
  $closing = $('.bg-closing');

  $w.scroll(function() {
    $.each(pages, function(k, i) {
      var offsetTop = $cached[i].offset().top;
      if(k == 'closing') return;

      var value = $w.scrollTop() + (($w.height() - 420) / 2) > offsetTop;

      if(value != cachedValues[i]) {
        $cached[i][value ? 'addClass' : 'removeClass']('on');
      }

      cachedValues[i] = value;
    });

    var prct = ($w.scrollTop() - $closing_sky.height() + $w.height() - $closing.offset().top) / ($w.height() - $closing_sky.height());
    var s = Math.ceil(prct * 2);

    fire(1, prct, s);
    fire(2, prct, s);
  })

  var $sky = {
    1: $('.sky1'),
    2: $('.sky2'),
  };

  var $sun = $('.sun');

  function fire(i, prct, s) {
    if(s === -0) s = 0;

    var opacity = 0;
    if(i === s) {
      opacity = (prct - ((s-1)*0.5)) * 2;
    } else if(i < s) {
      opacity = 1;
    }

    $sky[i].css('opacity', opacity);
    if(i === 1) {
      $sun.css('transform', 'translate('+ (100 * opacity) +'px,'+(250 * opacity)+'px) rotate('+(20 * opacity)+'deg)');
    }
  }

  $('.top a, .bottom-toc').click(function(e) {
    e.preventDefault();
    $(window).scrollTop($('#toc').offset().top);
  });

  $('.toc a').click(function(e) {
    e.preventDefault();
    $(window).scrollTop($($(this).attr('href')).offset().top);
  });

})();
